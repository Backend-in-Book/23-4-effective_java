# 아이템 78: 공유 중인 가변 데이터는 동기화해 사용하라

## 동기화

- Mutli-thread를 잘 사용하면 좋은 성능을 낼 수 있다.
  - 하지만 스레드간 동기화는 반드시 고려해야한다.
  - 만약 동기화를 고려하지 않는다면, 서로 공유하는 데이터에 대해 안정성과 신뢰성을 보장할 수 없고, 이는 곧 프로그램의 일관성 및 안정성을 보장할 수 없다는 것이다.

- 동기화의 2가지 기능

- 배타적 실행(Exclusion): 한 스레드가 객체를 변경하는 중이라, 상태가 일관되지 않은 순간의 객체를 다른 스레드가 보지 못하게 막는 것
  - 한 객체가 일관된 상태를 가지고 생성되고, 이 객체에 접근하는 메서드는 그 객체에 락을 건다.
    - 락을 건 메서드는 객체의 상태를 확인하고 필요하면 수정한다.
  - 일관된 상태에서 다른 일관된 상태로 변화시킴으로서 이 객체의 상태가 일관되지 않은 순간을 볼 수 없게 한다.
- 스레드간의 통신(Communication): 한 스레드가 만든 변화를 다른 스레드에서 볼 수 있게 하는 것
  - 동기화된 메서드나 블록에 들어간 스레드가 같은 락의 보호하에 수행된 모든 수정의 최종 결과를 보게 해준다.

## `synchronized`

Java에서는 synchronized 키워드를 통해 메서드나 블록을 한번에 한 스레드씩 수행하도록 보장함으로써 동기화를 지원하고 있다.

- long, double을 제외한 변수를 읽고 쓰는 동작은 원자적이다.
  - 이는 여러 스레드가 같은 변수를 동기화 없이 수정하는 중이더라도, 어떤 스레드가 정상적으로 저장한 값을 온전히 읽어옴을 보장한다.
  - 하지만 한 스레드가 저장한 값이 다른 스레드에게 보이는가를 보장하지 않는다.

## 동기화 문제를 피하는 좋은 방법

- 가변 데이터를 공유하지 않는다.
  - 불변 데이터만 공유한다.
  - 가변 데이터는 단일 스레드에서만 사용한다.
  - 문서화를 잘 하자.

